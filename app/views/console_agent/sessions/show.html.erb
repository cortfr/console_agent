<a href="<%= console_agent.sessions_path %>" class="back-link">&larr; Back to sessions</a>

<div class="meta-card">
  <div class="meta-grid">
    <div class="meta-item">
      <label>Query</label>
      <span><%= @session.query %></span>
    </div>
    <div class="meta-item">
      <label>Mode</label>
      <span class="badge badge-<%= @session.mode %>"><%= @session.mode %></span>
    </div>
    <div class="meta-item">
      <label>User</label>
      <span><%= @session.user_name || '-' %></span>
    </div>
    <div class="meta-item">
      <label>Provider / Model</label>
      <span><%= @session.provider %> / <%= @session.model %></span>
    </div>
    <div class="meta-item">
      <label>Tokens (in / out)</label>
      <span class="mono"><%= @session.input_tokens %> / <%= @session.output_tokens %></span>
    </div>
    <div class="meta-item">
      <label>Duration</label>
      <span class="mono"><%= @session.duration_ms ? "#{@session.duration_ms}ms" : '-' %></span>
    </div>
    <div class="meta-item">
      <label>Executed?</label>
      <span><%= @session.executed? ? '<span class="check">Yes</span>'.html_safe : '<span class="cross">No</span>'.html_safe %></span>
    </div>
    <div class="meta-item">
      <label>Time</label>
      <span><%= @session.created_at.strftime('%Y-%m-%d %H:%M:%S') %></span>
    </div>
  </div>
</div>

<h3 style="margin-bottom: 12px; font-size: 16px;">Conversation</h3>

<%
  # Find the last assistant message that contains the executed code,
  # so we can show execution results right after it
  exec_after_index = nil
  if @session.code_executed.present?
    @conversation.each_with_index do |msg, i|
      if msg['role'] == 'assistant' && msg['content'].to_s.include?(@session.code_executed.to_s.lines.first.to_s.strip)
        exec_after_index = i
      end
    end
    # Fallback: show after the last assistant message
    exec_after_index ||= @conversation.rindex { |msg| msg['role'] == 'assistant' }
  end
%>

<% @conversation.each_with_index do |msg, i| %>
  <div class="message message-<%= msg['role'] %>">
    <div class="message-role"><%= msg['role'] %></div>
    <div class="message-content"><%= format_message_content(msg['content'].to_s) %></div>
  </div>

  <% if exec_after_index == i && @session.executed? %>
    <div class="message message-execution">
      <div class="message-role">execution</div>
      <% if @session.code_output.present? %>
        <div class="exec-label">Output</div>
        <pre><%= h(@session.code_output) %></pre>
      <% end %>
      <% if @session.code_result.present? %>
        <div class="exec-label">Return value</div>
        <pre><%= h(@session.code_result) %></pre>
      <% end %>
    </div>
  <% end %>
<% end %>

<% if @session.code_executed.present? && !@session.executed? %>
  <div class="message message-execution">
    <div class="message-role">code (not executed)</div>
    <pre><%= h(@session.code_executed) %></pre>
  </div>
<% end %>

<a href="<%= console_agent.sessions_path %>" class="back-link">&larr; Back to sessions</a>

<div class="meta-card">
  <div class="meta-grid">
    <div class="meta-item">
      <label>Query</label>
      <span><%= @session.query %></span>
    </div>
    <div class="meta-item">
      <label>Mode</label>
      <span class="badge badge-<%= @session.mode %>"><%= @session.mode %></span>
    </div>
    <div class="meta-item">
      <label>User</label>
      <span><%= @session.user_name || '-' %></span>
    </div>
    <div class="meta-item">
      <label>Provider / Model</label>
      <span><%= @session.provider %> / <%= @session.model %></span>
    </div>
    <div class="meta-item">
      <label>Tokens (in / out)</label>
      <span class="mono"><%= @session.input_tokens %> / <%= @session.output_tokens %></span>
    </div>
    <div class="meta-item">
      <label>Duration</label>
      <span class="mono"><%= @session.duration_ms ? "#{@session.duration_ms}ms" : '-' %></span>
    </div>
    <div class="meta-item">
      <label>Executed?</label>
      <span><%= @session.executed? ? '<span class="check">Yes</span>'.html_safe : '<span class="cross">No</span>'.html_safe %></span>
    </div>
    <div class="meta-item">
      <label>Time</label>
      <span><%= @session.created_at.strftime('%Y-%m-%d %H:%M:%S') %></span>
    </div>
  </div>
</div>

<h3 style="margin-bottom: 12px; font-size: 16px;">Conversation</h3>

<% @conversation.each do |msg| %>
  <div class="message message-<%= msg['role'] %>">
    <div class="message-role"><%= msg['role'] %></div>
    <div class="message-content"><%= h(msg['content'].to_s) %></div>
  </div>
<% end %>

<% if @session.code_executed.present? %>
  <div class="exec-section">
    <h3>Code Executed</h3>
    <pre><%= h(@session.code_executed) %></pre>
  </div>
<% end %>

<% if @session.executed? %>
  <% if @session.code_output.present? %>
    <div class="exec-section">
      <h3>Output</h3>
      <pre><%= h(@session.code_output) %></pre>
    </div>
  <% end %>

  <% if @session.code_result.present? %>
    <div class="exec-section">
      <h3>Return Value</h3>
      <pre><%= h(@session.code_result) %></pre>
    </div>
  <% end %>
<% end %>
